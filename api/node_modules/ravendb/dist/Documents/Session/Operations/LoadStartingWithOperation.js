"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const GetDocumentsCommand_1 = require("../../Commands/GetDocumentsCommand");
const DocumentInfo_1 = require("../DocumentInfo");
const TypeUtil_1 = require("../../../Utility/TypeUtil");
class LoadStartingWithOperation {
    constructor(session) {
        this._returnedIds = [];
        this._session = session;
    }
    createRequest() {
        this._session.incrementRequestCount();
        return new GetDocumentsCommand_1.GetDocumentsCommand({
            startsWith: this._startWith,
            startsAfter: this._startAfter,
            matches: this._matches,
            exclude: this._exclude,
            start: this._start,
            pageSize: this._pageSize,
            metadataOnly: false
        });
    }
    withStartWith(idPrefix, opts) {
        const optsToUse = Object.keys(LoadStartingWithOperation.DEFAULT)
            .reduce((result, next) => {
            result[next] = TypeUtil_1.TypeUtil.isNullOrUndefined(opts[next])
                ? LoadStartingWithOperation.DEFAULT[next]
                : opts[next];
            return result;
        }, {});
        this._startWith = idPrefix;
        this._matches = optsToUse.matches;
        this._start = optsToUse.start;
        this._pageSize = optsToUse.pageSize;
        this._exclude = optsToUse.exclude;
        this._startAfter = optsToUse.startAfter;
    }
    setResult(result) {
        for (const document of result.results) {
            const newDocumentInfo = DocumentInfo_1.DocumentInfo.getNewDocumentInfo(document);
            this._session.documentsById.add(newDocumentInfo);
            this._returnedIds.push(newDocumentInfo.id);
        }
    }
    getDocuments(docType) {
        const entityType = this._session.conventions.findEntityType(docType);
        return this._returnedIds.reduce((result, id) => {
            const doc = this._getDocument(entityType, id);
            return [...result, doc];
        }, []);
    }
    _getDocument(entityType, id) {
        if (!id) {
            return null;
        }
        if (this._session.isDeleted(id)) {
            return null;
        }
        const doc = this._session.documentsById.getValue(id);
        if (doc) {
            return this._session.trackEntity(entityType, doc);
        }
        return null;
    }
}
LoadStartingWithOperation.DEFAULT = {
    start: 0,
    pageSize: 25,
    exclude: null,
    startAfter: null,
    matches: null
};
exports.LoadStartingWithOperation = LoadStartingWithOperation;
